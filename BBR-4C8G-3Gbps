#!/bin/bash

# ==============================================================================
# Linux Network Optimization Script
# Target Specs: 4 vCPU, 8GB RAM, 3Gbps Uplink, ~50ms Latency
# ==============================================================================

# 1. 权限与环境检查
if [[ $EUID -ne 0 ]]; then
   echo "Error: This script must be run as root"
   exit 1
fi

echo "[+] Starting Network Optimization..."

# 2. 备份现有配置
echo "[+] Backing up existing sysctl.conf..."
cp /etc/sysctl.conf /etc/sysctl.conf.bak.$(date +%F-%T)

# 3. 写入优化配置
cat > /etc/sysctl.conf << 'EOF'
# --- System Limits ---
# 提高系统级文件描述符限制 (适应高并发连接)
fs.file-max = 1000000
fs.inotify.max_user_instances = 8192

# --- TCP Queue & Buffer (BDP: ~19MB required for 3Gbps@50ms) ---
# 3Gbps带宽下，保留充足的缓冲区冗余 (Max ~64MB)
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.optmem_max = 65535
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535

# TCP Memory: min pressure max (单位: page, 1 page = 4096 bytes)
# 8GB RAM充足，给予TCP协议栈足够内存空间
net.ipv4.tcp_mem = 786432 1048576 26777216
net.ipv4.tcp_rmem = 8192 262144 67108864
net.ipv4.tcp_wmem = 8192 262144 67108864

# --- UDP Optimization (Critical for QUIC/Hysteria) ---
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

# --- BBR & Congestion Control ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- TCP Connection Management ---
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.ip_local_port_range = 10000 65000
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2

# --- Keepalive (快速释放死链) ---
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3

# --- TCP Features ---
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 3

# TW Reuse (开启Reuse)
net.ipv4.tcp_tw_reuse = 1

# --- Security & Forwarding ---
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.default.forwarding = 1
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# 启用反向路径过滤 (安全加固)
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1

# 关闭路由到本地 (安全加固)
net.ipv4.conf.all.route_localnet = 0

# 禁用ICMP重定向 (防止路由劫持)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
EOF

# 4. 应用配置
echo "[+] Applying sysctl parameters..."
sysctl -p

echo "[+] Optimization Complete. Current Congestion Control:"
sysctl net.ipv4.tcp_congestion_control
