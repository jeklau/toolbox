#!/bin/bash

# ==============================================================================
# Linux Network Optimization Script
# Target Specs: 1 vCPU, 1GB RAM, 1Gbps Uplink
# Focus: Survival, Low Latency, Anti-OOM
# ==============================================================================

# 1. 检查Root权限
if [[ $EUID -ne 0 ]]; then
   echo "Error: This script must be run as root"
   exit 1
fi

echo "[+] Starting Optimization for 1C/1G Micro Instance..."

# 2. 备份
echo "[+] Backing up sysctl.conf..."
cp /etc/sysctl.conf /etc/sysctl.conf.bak.$(date +%F-%T)

# 3. 写入极限精简配置
cat > /etc/sysctl.conf << 'EOF'
# --- System Limits (Strictly Limited) ---
# 1GB 内存下，文件句柄不宜过大，防止管理开销过高
fs.file-max = 100000
fs.inotify.max_user_instances = 1024

# --- TCP Memory Safety (The "Do Not Crash" Zone) ---
# 单位: pages (4096 bytes)
# 限制 TCP 总内存使用不超过系统内存的 ~10-15%
# Max 设为 ~128MB。如果超过此值，内核将丢弃新包以保护系统不崩溃。
net.ipv4.tcp_mem = 16384 24576 32768

# 单个 Socket 缓冲区限制
# 1Gbps BDP ~6MB.
# 我们将最大值限制在 12MB (12582912)，这是跑满带宽的理论下限。
# 绝不能设为 32MB 或 64MB，否则几个大流量连接就会耗尽 1G 内存。
net.core.rmem_max = 12582912
net.core.wmem_max = 12582912
net.core.rmem_default = 65536
net.core.wmem_default = 65536
net.core.optmem_max = 16384

# --- Queue Management (Reduce CPU Load) ---
# 队列太长会导致 CPU 处理不过来时延迟剧增。
# 1核 CPU 处理能力有限，减小队列长度，让包尽早丢弃触发重传，反而比卡死好。
net.core.somaxconn = 2048
net.core.netdev_max_backlog = 2048

# TCP Read/Write Buffer
net.ipv4.tcp_rmem = 4096 65536 12582912
net.ipv4.tcp_wmem = 4096 65536 12582912

# --- Congestion Control ---
# 依然使用 BBR，它是处理丢包最好的算法
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- UDP Optimization (Conservative) ---
# 限制 UDP 缓冲区，防止 QUIC/Hysteria 抢占过多内存
net.ipv4.udp_rmem_min = 4096
net.ipv4.udp_wmem_min = 4096

# --- Connection Management ---
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_slow_start_after_idle = 0
# 降低 notsent_lowat 以减少 buffer bloat，节省内存
net.ipv4.tcp_notsent_lowat = 8192
net.ipv4.ip_local_port_range = 10000 65000

# Keepalive (激进回收)
# 1C1G 经不起大量死连接占用资源
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_keepalive_probes = 3

# --- Essential Features ---
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_tw_reuse = 1

# --- Security ---
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.default.forwarding = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.route_localnet = 0
EOF

# 4. 应用配置
echo "[+] Applying sysctl parameters..."
sysctl -p

echo "[+] Done. Optimized for 1C/1G Stability."
