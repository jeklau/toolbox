#!/bin/bash

# ==============================================================================
# Linux Network Optimization Script
# Target Specs: 2 vCPU, 2GB RAM, 1Gbps Uplink
# Focus: Memory Safety & Throughput Balance
# ==============================================================================

# 1. 检查Root权限
if [[ $EUID -ne 0 ]]; then
   echo "Error: This script must be run as root"
   exit 1
fi

echo "[+] Starting Optimization for 2C/2G instance..."

# 2. 备份
echo "[+] Backing up sysctl.conf..."
cp /etc/sysctl.conf /etc/sysctl.conf.bak.$(date +%F-%T)

# 3. 写入轻量化配置
cat > /etc/sysctl.conf << 'EOF'
# --- System Limits (Scaled down for 2GB RAM) ---
# 文件句柄：够用即可，过大浪费内核内存
fs.file-max = 512000
fs.inotify.max_user_instances = 4096

# --- TCP Memory Safety (Crucial for 2GB RAM) ---
# 单位: pages (4096 bytes)
# 限制 TCP 总内存使用不超过系统内存的 ~15-20%
# Low: ~160MB, Pressure: ~200MB, Max: ~320MB
net.ipv4.tcp_mem = 40960 54613 81920

# 单个 Socket 缓冲区限制
# 1Gbps BDP ~6MB. Max 设为 ~25MB 足够应对突发，防止OOM
net.core.rmem_max = 26214400
net.core.wmem_max = 26214400
net.core.rmem_default = 65536
net.core.wmem_default = 65536
net.core.optmem_max = 40960
net.core.somaxconn = 8192
net.core.netdev_max_backlog = 8192

# TCP Read/Write Buffer (Min, Default, Max)
# 减小默认值，让内存按需分配，而不是一开始就占满
net.ipv4.tcp_rmem = 4096 65536 26214400
net.ipv4.tcp_wmem = 4096 65536 26214400

# --- Congestion Control ---
# 1Gbps 依然推荐 BBR + FQ
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- UDP Optimization (For TUIC/Hysteria/QUIC) ---
# 适度优化，避免 UDP Flood 消耗过多内存
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# --- Connection Management ---
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.ip_local_port_range = 10000 65000

# Keepalive (保持连接活性)
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3

# --- Essential Features ---
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_tw_reuse = 1

# --- Security ---
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.default.forwarding = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.route_localnet = 0
EOF

# 4. 应用配置
echo "[+] Applying sysctl parameters..."
sysctl -p

echo "[+] Done. Memory limits secured for 2GB RAM."
